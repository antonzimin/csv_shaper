<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="README.md"><meta name="groc-github-url" content="https://github.com/paulspringett/paulspringett"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/paulspringett/paulspringett/blob/master/README.md">README.md</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="csv-shaper">CSV Shaper</h1>

<p>Beautiful DSL for creating CSV output in Ruby &amp; Rails.</p>

<p>Creating CSV files in Ruby is painful! CSV Shaper makes life easier! It's ideal for converting database backed models with attributes into CSV output. It can be used without Rails, but works great with ActiveRecord models and even comes with support for its own template handling.</p>

<p><a href="http://travis-ci.org/paulspringett/csv_shaper"><img src="https://secure.travis-ci.org/paulspringett/csv_shaper.png?branch=master" alt="Build Status" title="" /></a></p>

<p>Annotated source: http://paulspringett.github.com/csv_shaper/</p>

<h3 id="example-usage">Example Usage</h3>

<pre><code class="ruby">csv_string = CsvShaper.encode do |csv|
  csv.headers :name, :age, :gender, :pet_names

  csv.rows @users do |csv, user|
    csv.cells :name, :age, :gender

    if user.pets.any?
      csv.cell :pet_names
    end
  end
end
</code></pre>

<h3 id="install">Install</h3>

<p>Install using Rubygems</p>

<pre><code class="bash">$ gem install csv_shaper
</code></pre>

<p>Or if you want to use it in your Rails app, add the following line to your Gemfile</p>

<pre><code class="ruby">gem 'csv_shaper'
</code></pre>

<p>and then run</p>

<pre><code class="bash">$ bundle install
</code></pre>

<h3 id="usage">Usage</h3>

<p>Everything goes inside the <code>encode</code> block, like so</p>

<pre><code class="ruby">csv_string = CsvShaper::Shaper.encode do |csv|
  ...
end
</code></pre>

<h3 id="usage-in-rails-30">Usage in Rails 3.0+</h3>

<p>When using it in Rails your view template is rendered inside the <code>encode</code> block so you can just call the <code>csv</code> object directly.</p>

<p>In Rails the example at the top of the README would simply be:</p>

<pre><code class="ruby">csv.headers :name, :age, :gender, :pet_names

csv.rows @users do |csv, user|
  csv.cells :name, :age, :gender

  if user.pets.any?
    csv.cell :pet_names
  end
end
</code></pre>

<p>Create a Rails view, set the content-type to <code>csv</code> and the handler to <code>shaper</code>. For the view of the <code>index</code> action the filename would be:</p>

<pre><code>index.csv.shaper
</code></pre>

<p>then just start defining your headers and rows as per the examples.</p>

<h3 id="headers">Headers</h3>

<p>You must define the headers for your CSV output. This can be done in one of 3 ways.</p>

<h4 id="standard-attribute-list">Standard attribute list</h4>

<pre><code class="ruby">csv.headers :name, :age, :location
</code></pre>

<p>This would create headers like so:</p>

<pre><code class="csv">Name,Age,Location
</code></pre>

<h4 id="using-the-attribute-names-of-a-class">Using the attribute names of a Class</h4>

<p>Say you have a User ActiveRecord class with attributes of <code>:name, :age, :location</code>. Simply pass the class to the headers method</p>

<pre><code class="ruby">csv.headers User
</code></pre>

<h4 id="using-a-block-to-define-headers-and-custom-mappings">Using a block to define headers and custom mappings</h4>

<pre><code class="ruby">csv.headers do |csv|
  csv.columns :name, :age, :location
  csv.mappings name: 'Full name', location: 'Region'
end
</code></pre>

<p>This would create headers like so:</p>

<pre><code class="csv">Full name,Age,Region
</code></pre>

<p>The mappings are useful for pretty-ing up the names when creating the CSV. When creating cells below you should still use the column names, not the mapping names. eg. <code>:name</code> not <code>'Full name'</code></p>

<h3 id="rows-amp-cells">Rows &amp; Cells</h3>

<p>CSV Shaper allows you to define rows and cells in a variety of ways.</p>

<h4 id="basic-row-without-a-model">Basic row without a model</h4>

<pre><code class="ruby">csv.row do |csv|
  csv.cell :name, "Joe"
  csv.cell :age, 24
end
</code></pre>

<h4 id="passing-a-model-and-attributes">Passing a model and attributes</h4>

<pre><code class="ruby">csv.row @user, :name, :age, :location
</code></pre>

<p>This will call the column names (name, age...) on <code>@user</code> and assign them to the correct cells. The output from the above Ruby might look like:</p>

<pre><code>Paul,27,United Kingdom
</code></pre>

<h4 id="passing-a-model-to-a-block">Passing a model to a block</h4>

<pre><code class="ruby">csv.row @user do |csv, user|
  csv.cells :name, :age
  if user.show_gender?
    csv.cell :gender
  end

  csv.cell :exported_at, Date.today.to_formatted_s(:db)
end
</code></pre>

<p>Any calls here to <code>cell</code> without a second argument are called on the model (<code>user</code>), otherwise the second parameter is used as a static value.</p>

<p>The <code>cells</code> method only takes a list of Symbols that are called as methods on the model (<code>user</code>).</p>

<p>The output from the above Ruby might look like:</p>

<pre><code>Paul,27,Male,2012-07-25
</code></pre>

<h3 id="multiple-rows">Multiple Rows</h3>

<p>You can pass an Enumerable and a block to <code>csv.rows</code> like so</p>

<pre><code class="ruby">csv.rows @users do |csv, user|
  csv.cells :name, :age, :location, :gender
  csv.cell :exported_at, Time.now
end
</code></pre>

<h3 id="dont-worry-about-missing-cells">Don't worry about missing cells</h3>

<p>There's no need to pad missing cells with <code>nil</code></p>

<p>This Ruby code will produce the CSV output below</p>

<pre><code class="ruby">csv.headers :name, :age, :gender

csv.row do |csv|
  csv.cell :name, 'Paul'
  # no age cell
  csv.cell :gender, 'M'
end

csv.row do |csv|
  csv.cell :name 'Joe'
  csv.cell :age, 34
  # no gender cell
end
</code></pre>

<pre><code>Name,Age,Gender
Paul,,M
Joe,34,
</code></pre>

<h3 id="further-rails-integration">Further Rails integration</h3>

<p>Customise the filename of the CSV download by defining a <code>@filename</code> instance variable in your controller action.</p>

<pre><code class="ruby">respond_to :html, :csv

def index
  @users = User.all
  @filename = "All users - #{Date.today.to_formatted_s(:db)}.csv"
end
</code></pre>

<h3 id="csv-configuration">CSV configuration</h3>

<p>To configure how the CSV output is formatted you can define a configure block, like so:</p>

<pre><code class="ruby">CsvShaper.configure do |config|
  config.col_sep = "\t"
  config.write_headers = false
end
</code></pre>

<p>Inside the block you can pass any of the standard library <a href="http://ruby-doc.org/stdlib-1.9.2/libdoc/csv/rdoc/CSV.html#DEFAULT_OPTIONS">CSV DEFAULT_OPTIONS</a>, as well as a <code>write_headers</code> option (default: <code>true</code>).
Setting this to <code>false</code> will exclude the headers from the final CSV output.</p>

<p>If you're using Rails you can put this in an initializer.</p>

<p>To configure CSV output locally to change global behavior you can define a configure hash, like so:</p>

<pre><code class="ruby">CsvShaper.encode(col_sep: "\t") do |csv|
  ...
end
</code></pre>

<h3 id="contributing">Contributing</h3>

<ol>
<li>Fork it</li>
<li>Create a semantically named feature branch</li>
<li>Write your feature</li>
<li>Add some tests for it</li>
<li>Commit your changes &amp; push to GitHub (do not change the gem's version number)</li>
<li>Submit a pull request with relevant details</li>
</ol>

<h5 id="hat-tips">Hat tips</h5>

<ul>
<li><a href="https://github.com/rails/jbuilder/">Jbuilder</a> for inspiration for the DSL</li>
<li><a href="https://github.com/econsultancy/csv_builder">CSV Builder</a> for headers and custom filenames</li>
</ul>

<p>Copyright (c) Paul Springett 2012</p></div></div></div></div></body></html>